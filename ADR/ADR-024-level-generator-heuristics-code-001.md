# ADR-024: Детерминированный LevelGenerator с эвристиками word-first

- Статус: accepted
- Дата: 2026-02-25
- Связанные задачи: [CODE]-[001]

## Контекст

Для этапа CODE-001 требовался production-контур генерации уровней вместо bootstrap-заглушки:

- генерация должна быть воспроизводимой при фиксированном `seed`;
- target-набор должен соответствовать PRD (3..7 слов, short/medium/long mix, минимум одно длинное слово);
- укладка слов должна идти word-first через 8-направленные пути с разрешёнными пересечениями;
- при неудачной укладке нужны ретраи без полного сброса всего набора;
- необходимы anti-repeat и rejection правила по редким буквам.

## Решение

1. Реализовать deterministic RNG внутри `LevelGenerator` на основе seed-driven генератора псевдослучайных чисел.
2. Формировать target-набор из словаря по length/rank:
   - short: `3..4`;
   - medium: `5..6`;
   - long: `>=7` (в текущем словаре до `10`);
   - обязательный минимум: по одному слову из каждой категории, далее добор до `N` (3..7).
3. Встроить anti-repeat приоритет по `recentTargetWords`:
   - сначала выбираются слова вне недавнего окна;
   - при нехватке допускается controlled fallback к недавним словам, чтобы генерация не блокировалась.
4. Реализовать retry policy без полного reset набора:
   - первичный fallback: замена только проблемного слова;
   - вторичный fallback: локальный backtracking на предыдущие слова;
   - полный restart попытки разрешён только после исчерпания локальных вариантов.
5. Ввести rejection rules для редких букв (`ъ/ы/ь/й/щ`) на двух уровнях:
   - target-набор;
   - финальный grid после заполнения пустых клеток.

## Последствия

- Генератор стал воспроизводимым и тестопригодным (доступны deterministic проверки по `seed`).
- Качество уровней стабилизировано базовыми эвристиками anti-repeat/rejection без усложнения архитектуры.
- Реализация остаётся в границах v1 (эвристики, а не тяжёлый оптимизатор раскладки), при этом покрывает PRD/TECHSPEC-инварианты для этапа CODE-001.

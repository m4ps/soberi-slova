# ADR-015: Runtime-инварианты state-модели и доменная ошибка валидации

- Статус: accepted
- Дата: 2026-02-25
- Связанные задачи: [DATA]-[002]

## Контекст

После DATA-001 schema и сериализация `GameState` были зафиксированы, но отсутствовали явные runtime-инварианты уровня и контракт доменной ошибки при попытке создать невалидный snapshot.

TECHSPEC/PRD требуют обязательные ограничения для data-модели:
- grid `5x5`;
- только кириллица с отдельной `ё`;
- диапазон target-слов `3..7`;
- отсутствие дублей и пересечений в found-наборах;
- однонаправленные переходы статуса уровня.

Без этого malformed/несогласованные данные могли проходить в доменный слой и нарушать контракт поведения следующих этапов (`CoreState`, scoring/progression, restore/merge).

## Решение

1. Добавить специализированную доменную ошибку `GameStateDomainError` с контрактом:
   - `code`;
   - `message`;
   - `retryable = false`;
   - `context`.
2. Зафиксировать runtime-инварианты в `createLevelSession`:
   - проверка grid-size (`25`);
   - проверка кириллицы (`а-я`, `ё`) для grid/word-наборов;
   - проверка диапазона `targetWords` (`3..7`);
   - проверки дублей, membership и непересечения found-наборов.
3. Ввести явную валидацию однонаправленных переходов:
   - функция `assertLevelSessionTransition(previousSession, nextSession)`;
   - опциональная передача `previousState` в `createGameState` для валидации перехода при построении следующего snapshot.
4. Закрепить поведение unit-тестами с проверкой кодов доменных ошибок для каждого критичного инварианта.

## Последствия

- Data-layer теперь fail-fast отклоняет невалидные состояния на runtime trust-boundary с машинно-читаемыми кодами ошибок.
- Контракт инвариантов становится проверяемым и стабильным для следующих этапов (`DATA-003+`, `CODE-*`).
- Переходы статуса уровня контролируются явно и не могут “прыгать” через обязательный порядок.
